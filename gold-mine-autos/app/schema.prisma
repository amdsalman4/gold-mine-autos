datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())

  email                     String?         @unique
  username                  String?         @unique
  isAdmin                   Boolean         @default(false)

  paymentProcessorUserId    String?         @unique
  lemonSqueezyCustomerPortalUrl String?     // You can delete this if you're not using Lemon Squeezy as your payments processor.
  subscriptionStatus        String?         // 'active', 'cancel_at_period_end', 'past_due', 'deleted'
  subscriptionPlan          String?         // 'hobby', 'pro'
  datePaid                  DateTime?
  credits                   Int             @default(3)

  gptResponses              GptResponse[]
  contactFormMessages       ContactFormMessage[]
  tasks                     Task[]
  files                     File[]

  // savedListings             SavedListing[]

}

model GptResponse {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())
  updatedAt                 DateTime        @updatedAt

  user                      User            @relation(fields: [userId], references: [id])
  userId                    String

  content                   String
}

model Task {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())

  user                      User            @relation(fields: [userId], references: [id])
  userId                    String

  description               String
  time                      String          @default("1")
  isDone                    Boolean         @default(false)
}

model File {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())

  user                      User            @relation(fields: [userId], references: [id])
  userId                    String

  name                      String
  type                      String
  s3Key                     String
}

model DailyStats {
  id                               Int             @id @default(autoincrement())
  date                             DateTime        @default(now()) @unique

  totalViews                       Int             @default(0)
  prevDayViewsChangePercent        String          @default("0")
  userCount                        Int             @default(0)
  paidUserCount                    Int             @default(0)
  userDelta                        Int             @default(0)
  paidUserDelta                    Int             @default(0)
  totalRevenue                     Float           @default(0)
  totalProfit                      Float           @default(0)

  sources                          PageViewSource[]
}

model PageViewSource {
  @@id([date, name])
  name                     String
  date                     DateTime        @default(now())

  dailyStats               DailyStats?     @relation(fields: [dailyStatsId], references: [id])
  dailyStatsId             Int?

  visitors                 Int
}

model Logs {
  id                       Int             @id @default(autoincrement())
  createdAt                DateTime        @default(now())

  message                  String
  level                    String
}

model ContactFormMessage {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())

  user                      User            @relation(fields: [userId], references: [id])
  userId                    String

  content                   String
  isRead                    Boolean         @default(false)
  repliedAt                 DateTime?
}

model Listing {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())
  updatedAt                 DateTime        @updatedAt

  // Vehicle Information
  make                      String
  model                     String
  year                      Int
  kilometers                Int
  vin                       String?
  trim                      String?
  transmission              String?         // "Auto", "Manual"
  engine                    String?         // "2.0L I4", "3.5L V6"
  fuelType                  String?         // "Gas", "Diesel", "Electric", "Hybrid"
  drivetrain                String?         // "FWD", "RWD", "AWD", "4WD"
  
  // Auction Details
  auctionLink               String
  auctionDate               DateTime
  currentHighBid            Float?
  currentHighBidder         String?
  auctionLocation           String?         // "Toronto (Oshawa)"
  auctionSite               String?         // "IAA Toronto", "Copart"
  lotNumber                 String?         // "12471031"
  laneNumber                String?         // "Lane: 3 Run: 45"
  
  // Vehicle Condition
  vehicleStatus             String?         // "Starts", "Runs", "Stationary"
  damageArea                String?         // "Front End", "Left Side"
  titleBrand                String?         // "ON-NOT BRANDED", "ON-SALVAGE"
  
  // Images
  imageUrls                 String[]        @default([])
  primaryImage              String?
  
  // Damage Assessment
  damageEstimate            Float
  
  // Financial Report
  estimatedMarketValue      Float
  recommendedMaxBid         Float
  absoluteMaxBid            Float
  profitMargin              Float
  estimatedTotalInvestment  Float
  
  // Admin Analysis Notes
  analysisNotes             String?         // Admin's written analysis (2-3 sentences)
  
  // Report Details - Main Selling Points
  mainPoints                String[]
  carGurusLink              String?
  
  // Estimated Costs Breakdown
  auctionOverhead           Float           @default(500)    // Auction fees
  towingCost                Float           @default(0)
  detailingCost             Float           @default(0)
  extraCosts                Float           @default(0)      // Safety cert, buffer costs
  
  // Repair Details (JSON for flexibility with multiple repairs)
  repairs                   Json?           // { items: [{ description: "Front bumper", partsLink: "...", partsCost: 200, labour: 150 }] }
  
  // User Feedback
  userFeedback              ListingFeedback[]
  
  // Metadata
  addedBy                   User            @relation(fields: [addedById], references: [id])
  addedById                 String
  
  status                    String          @default("active") // "active", "sold", "expired"
}

model ListingFeedback {
  id                        String          @id @default(uuid())
  createdAt                 DateTime        @default(now())
  
  listing                   Listing         @relation(fields: [listingId], references: [id], onDelete: Cascade)
  listingId                 String
  
  user                      User            @relation(fields: [userId], references: [id])
  userId                    String
  
  // What they're correcting
  feedbackType              String          // "market_value", "repair_cost", "towing", "other"
  suggestedValue            Float?          // Their suggested number
  notes                     String?         // Free-form explanation
  
  isReviewed                Boolean         @default(false) // Admin has seen it
}